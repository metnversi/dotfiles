#!/usr/sbin/nft -f
flush ruleset

table inet max_secu {
	set dhcp_dns {
		type ipv4_addr
		flags interval
		elements = { 0.0.0.0, 1.1.1.1,
			     192.168.1.8 }
	}

	set cloudflare_tunnel {
		type ipv4_addr
		flags interval
        elements = { # :) No, I hidden them }
	}

	set LANv4 {
		type ipv4_addr
		flags interval
		elements = { 169.254.0.0/16, 172.17.0.0/16,
			     192.168.1.0/26 }
	}

	set LANv6 {
		type ipv6_addr
		flags interval
		elements = { fd00::/8,
			     fe80::/10 }
	}

	set localhost {
		type ipv4_addr
		flags interval
		elements = { 127.0.0.1 }
	}

	set strictLANv4 {
		type ipv4_addr
		flags interval
		elements = { 192.168.1.5, 192.168.1.99 }
	}

	set blackhole_ipv4 {
		type ipv4_addr
		size 65536
		flags dynamic,timeout
		timeout 10m
	}

	set blackhole_ipv6 {
		type ipv6_addr
		size 65536
		flags dynamic,timeout
	}

	set https {
		type ipv4_addr
		size 65536
		flags dynamic,timeout
		timeout 1h
	}

	set flood_ipv4 {
		type ipv4_addr
		size 128000
		flags dynamic,timeout
	}

	set flood_ipv6 {
		type ipv6_addr
		size 128000
		flags dynamic,timeout
	}

	chain dhcp_dns {
		udp dport { 53, 67, 2049 } accept
	}

	chain netops_ingress_lanv4 {
		udp dport { 137, 138 } counter accept comment "Accept NetBIOS Name Service (nmbd)"
		tcp dport { 80, 443, 5432, 6081, 6641, 6642, 8080 } counter accept
		udp dport { 3702, 5000-6000, 6081, 6641-6642 } counter accept
	}

	chain strict_network {
		tcp sport 5432 ct state established,new counter accept
		meta l4proto { icmp, ipv6-icmp } counter accept comment "Accept ICMP"
		tcp dport { 8080, 8888 } ct state established,new counter accept
		log prefix "nftables [LANv4-ingress-allowed]: "
	}

	chain netops_egress_lan {
		tcp dport { 22, 80, 443, 32768-60999} ct state established,new counter accept
	}

	chain netops_ingress {
		type filter hook input priority filter; policy drop;
		iif "lo" counter accept comment "Accept any localhost traffic"
		ct state invalid counter drop comment "Drop invalid connections"
		ct state established,related counter accept comment "Accept traffic originated from us"
		ct state new tcp dport { 22, 443 } \
                update @flood_ipv4 \
                { ip saddr timeout 10s limit rate over 10/second burst 5 packets } \
                log prefix "nftables [BLACKHOLE]: " \
                add @blackhole_ipv4 \
                { ip saddr timeout 3m }
		ct state new tcp dport { 22, 443 } \
                update @flood_ipv6 \
                { ip6 saddr & ffff:ffff:ffff:ffff:: timeout 10s limit rate over 10/second burst 5 packets } \
                log prefix "nftables [BLACKHOLE]: " \
                add @blackhole_ipv6 \
                { ip6 saddr & ffff:ffff:ffff:ffff:: timeout 3m }
		ip saddr @blackhole_ipv4 tcp flags syn counter drop
		ip saddr @dhcp_dns jump dhcp_dns comment "allow dhcp, dns"
		ct state new tcp dport 443 update @https { ip saddr counter }
		ip6 saddr & ffff:ffff:ffff:ffff:: == @blackhole_ipv6 counter drop
		ip saddr @LANv4 jump netops_ingress_lanv4 comment "Connections from private IPv4"
		ip saddr @localhost tcp dport 22 ct state established,new counter accept comment "Strict SSH access to localhost only"
		tcp dport 22 ct state new limit rate 15/minute burst 5 packets accept comment "Avoid brute force on SSH"
		ip6 saddr @LANv6 jump netops_ingress_lanv4 comment "Connections from private IPv6"
		fib daddr . iif type != { local, broadcast, multicast } drop comment "Drop if the dest IP is not configured on the incoming interface (strong host model)"
		icmp type echo-request limit rate over 10/second burst 4 packets drop comment "No ping floods"
		icmpv6 type echo-request limit rate over 10/second burst 4 packets drop comment "No ping floods"
		log prefix "nftables [INGRESS]: " flags ip options
	}

	chain netops_forward {
		type filter hook forward priority filter; policy drop;
		log prefix "nftables [FORWARD]: " flags ip options
	}

	chain netops_egress {
		type filter hook output priority filter; policy drop;
		oif "lo" counter accept comment "Accept any localhost traffic"
		ip daddr @LANv4 jump netops_egress_lan comment "allow outbound TCP connection"
        # a cloudflared rule. added this position.
		ip daddr @strictLANv4 ct state established,new counter accept
		tcp dport 443 ct state established,new counter accept
		ip daddr @dhcp_dns udp dport 53 counter counter accept
		log prefix "nftables [EGRESS]: " flags ip options
	}
}
