#!/usr/sbin/nft -f
flush ruleset

# mirroring traffic to IDS
# table ip ids_mirror {
#     chain mirror_traffic {
#         type filter hook prerouting priority -150;
#         dup to 192.168.1.8 device "br-ex"
#     }
# }

table inet max_secu {
    # sysctl -a |grep net.netfilter.nf_conntrack_tcp_timeout_
    ct timeout customtimeout {
        protocol tcp;
        l3proto ip;
        policy = { established: 30, close: 20 }
    }

    quota q_user_installer { over 3000 mbytes }
    quota q_host_99 { over 500 mbytes }
    
	set dhcp_dns {
		type ipv4_addr
		flags interval
		elements = { 0.0.0.0, 1.1.1.1,
			     8.8.8.8, 192.168.1.8 }
	}

	set LANv4 {
		type ipv4_addr
		flags interval
		elements = { 169.254.0.0/16, 192.168.1.0/26 }
	}

	set LANv6 {
		type ipv6_addr
		flags interval
		elements = { fd00::/8,
			     fe80::/10 }
	}

	set localhost {
		type ipv4_addr
		flags interval
		elements = { 127.0.0.1 }
	}

	set strictLANv4 {
		type ipv4_addr
		flags interval
		elements = { 192.168.1.5, 192.168.1.99 }
	}

	set blackhole_ipv4 {
		type ipv4_addr
		size 65536
		flags dynamic,timeout
		timeout 10m
	}

	set blackhole_ipv6 {
		type ipv6_addr
		size 65536
		flags dynamic,timeout
	}

	set https {
		type ipv4_addr
		size 65536
		flags dynamic,timeout
		timeout 1h
	}

	set flood_ipv4 {
		type ipv4_addr
		size 128000
		flags dynamic,timeout
	}
	set term_ssh {
		type ipv4_addr
		flags dynamic
        timeout 1m
	}

	set flood_ipv6 {
		type ipv6_addr
		size 128000
		flags dynamic,timeout
	}

	map ingress_policy_map {
		type ipv4_addr : verdict
		flags interval
		elements = { 127.0.0.1 : accept,
			     192.168.1.0/26 : jump netops_ingress_layer4 }
	}

	chain dhcp_dns {
		udp dport { 53, 67, 2049 } accept
	}

	chain netops_ingress_layer4 {
		udp dport { 137, 138 } counter accept comment "Accept NetBIOS Name Service (nmbd)"
		tcp dport { 80, 443, 5432, 6081, 6641, 6642, 8080 } counter accept
		udp dport { 3702, 5000-6000, 6081, 6641-6642 } counter accept
	}

	chain strict_network {
		tcp sport 5432 ct state established,new counter accept
		meta l4proto { icmp, ipv6-icmp } counter accept comment "Accept ICMP"
		tcp dport { 8080, 8888 } ct state established,new counter accept
		log prefix "nftables [LANv4-ingress-allowed]: "
	}

	chain netops_egress_lan {
		tcp dport { 22, 80, 443, 5432, 8080, 32768-60999 } ct state established,new counter accept
		udp dport { 10000-60999 } ct state established,new counter accept
        # required nfnetlink_osf
        # osf name "Linux" accept
	}

	chain netops_raw {
		type filter hook prerouting priority raw; policy accept;
		ip saddr @blackhole_ipv4 counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: == @blackhole_ipv6 counter drop
        # nf_synproxy_ipv4, CONFIG_NETFILTER_SYNPROXY required
        #tcp dport 22 tcp flags syn notrack
        #tcp dport 22 synproxy mss 1460 wscale 7
        # for other backend
        # tcpdump -pni eth0 -c 1 'tcp[tcpflags] == (tcp-syn|tcp-ack)' port 80 &
        # echo 0 > /proc/sys/net/netfilter/nf_conntrack_tcp_loose        
	}

	chain netops_ingress {
		type filter hook input priority filter; policy drop;
        # ct state { invalid, untracked } synproxy mss 1460 wscale 7 timestamp sack-perm comment "3-way handshake"
		iif "lo" counter accept comment "Accept any localhost traffic"
		ct state invalid counter drop comment "Drop invalid connections"
		ct state established,related counter accept comment "Accept traffic originated from us"
        ip saddr 192.168.1.99 quota name "q_host_99" drop comment "Macbook nah"
        tcp dport 22 ct count over 2 add @term_ssh { ip saddr } reject
		ct state new tcp dport 22 update @flood_ipv4 { ip saddr timeout 10s limit rate over 10/second burst 5 packets } log prefix "nftables [BLACKHOLE]: " add @blackhole_ipv4 { ip saddr timeout 3m }
		ct state new tcp dport 22 update @flood_ipv6 { ip6 saddr & ffff:ffff:ffff:ffff:: timeout 10s limit rate over 10/second burst 5 packets } log prefix "nftables [BLACKHOLE]: " add @blackhole_ipv6 { ip6 saddr & ffff:ffff:ffff:ffff:: timeout 3m }
		ip saddr vmap @ingress_policy_map
		ip saddr @dhcp_dns jump dhcp_dns comment "allow dhcp, dns"
		ct state new tcp dport 443 update @https { ip saddr counter }
		tcp dport 22 ct state new limit rate 15/minute burst 5 packets accept comment "Avoid brute force on SSH"
		ip6 saddr @LANv6 jump netops_ingress_layer4 comment "Connections from private IPv6"
		fib daddr . iif type != { local, broadcast, multicast } drop comment "Drop if the dest IP is not configured on the incoming interface (strong host model)"
		icmp type echo-request limit rate over 10/second burst 4 packets drop comment "No ping floods"
		icmpv6 type echo-request limit rate over 10/second burst 4 packets drop comment "No ping floods"
		log prefix "nftables [INGRESS-FILTERED]: " flags ether
	}

	chain netops_forward {
		type filter hook forward priority filter; policy drop;
		log prefix "nftables [FORWARD-FILTERED]: " flags skuid
	}

    chain netops_egress {    
		type filter hook output priority filter; policy drop;
        ip protocol tcp ct state new ct timeout set "customtimeout"
		oif "lo" accept comment "Allow localhost"
		ct state established,related accept comment "Allow responses to incoming traffic"
        # skuid "oriana" meta hour 1-18 meta day "Monday"-"Thursday" drop
        # skuid "rose" quota name "q_user_installer" drop
		skuid {"oriana", "root", "_apt", "rose" } jump netops_egress_lan comment "main user traffic's access list"
        skuid "dnsmasq" udp dport 53 accept comment "Allow dnsmasq to resolve upstream"
        skuid "dnsmasq" tcp dport 53 accept comment "Allow dnsmasq to resolve upstream (DNS TCP fallback)"
		skuid "root" udp dport 53 accept comment "Allow Root for DNS"
		skuid "_chrony" udp dport 123 accept comment "Allow NTP sync"
		skuid { "www-data", "nobody" } log prefix "nftables [REVSHELL-ATTEMPT]: " drop
		log prefix "nftables [EGRESS-FILTERED]: " flags skuid
	}
}
